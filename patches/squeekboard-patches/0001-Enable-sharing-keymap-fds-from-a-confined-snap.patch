From 766aa7fc78af659d544db97c466e085c44d76e3c Mon Sep 17 00:00:00 2001
From: William Wold <wm@wmww.sh>
Date: Fri, 3 Sep 2021 14:17:46 -0700
Subject: [PATCH 1/2] Enable sharing keymap fds from a confined snap

---
 eek/eek-keyboard.c | 20 ++++++++++++++++----
 1 file changed, 16 insertions(+), 4 deletions(-)

diff --git a/eek/eek-keyboard.c b/eek/eek-keyboard.c
index a7e9735..8ddf017 100644
--- a/eek/eek-keyboard.c
+++ b/eek/eek-keyboard.c
@@ -20,6 +20,12 @@
 
 #include "config.h"
 
+#define _GNU_SOURCE
+#include <unistd.h>
+#include <sys/syscall.h>
+#include <sys/types.h>
+#undef _XOPEN_SOURCE
+
 #define _XOPEN_SOURCE 500
 #include <errno.h>
 #include <fcntl.h>
@@ -60,12 +66,18 @@ struct keymap squeek_key_map_from_str(const char *keymap_str) {
         r[i] = (r[i] & 0b1111111) | 0b1000000; // A-z
         r[i] = r[i] > 'z' ? '?' : r[i]; // The randomizer doesn't need to be good...
     }
-    int keymap_fd = shm_open(path, O_RDWR | O_CREAT | O_EXCL, 0600);
-    if (keymap_fd < 0) {
-        g_error("Failed to set up keymap fd");
+
+    int keymap_fd;
+    if (getenv("SNAP")) {
+        keymap_fd = syscall(SYS_memfd_create, "eek-map", MFD_CLOEXEC);
+    } else {
+        keymap_fd = shm_open(path, O_RDWR | O_CREAT | O_EXCL, 0600);
+        if (keymap_fd < 0) {
+            g_error("Failed to set up keymap fd at path %s", path);
+        }
+        shm_unlink(path);
     }
 
-    shm_unlink(path);
     if (ftruncate(keymap_fd, (off_t)keymap_len)) {
         g_error("Failed to increase keymap fd size");
     }
-- 
2.30.2

