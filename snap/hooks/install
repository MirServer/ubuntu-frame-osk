#!/bin/sh
set -x

if [ "$(snapctl get daemon)" = "" ]
then
  if grep -q -e snap_core= -e snapd_recovery_mode= /proc/cmdline
  then snapctl set daemon=true
  else snapctl set daemon=false
  fi
fi

layout_list_file="$SNAP/etc/layouts.txt"
osk_layout_option=""
# Loop through list of layouts dropping invalid entries
for layout in $(snapctl get layout | sed 's/,/ /g'); do
  if grep -Fx "$layout" "$layout_list_file" >/dev/null; then
    if [ -n "${osk_layout_option}" ]; then
      osk_layout_option="$osk_layout_option,$layout"
    else
      osk_layout_option="$layout"
    fi
  # No "else": we can't output any diagnostics without failing install/refresh
  fi
done
if [ -n "${osk_layout_option}" ]; then
  snapctl set layout="${osk_layout_option}"
fi

[ "$(snapctl get theme)" != "" ]  || snapctl set theme=light
